# Describe the steps for application initialization

# Overview

1. index.php
2. Mage::run($mageRunCode, $mageRunType);
3. Mage_Core_Model_App->run(array $options);
4. Mage_Core_Model_App->baseInit()
5. Mage_Core_Model_Config->loadBase()
6. Mage_Core_Model_App->\_initModules();
7. Mage_Core_Model_App->\_initCurrentStore($scopeCode, $scopeType);
8. Dispatches the Front Controller - more information [here](https://github.com/colinmurphy/magento-exam-notes/blob/master/2.%20Request%20Flow/2.%20Front%20Controller/2.%20Describe%20the%20role%20of%20the%20front%20controller.md)

Pour plus de détails [http://blog.belvg.com/magento-certified-developer-exam-application-initialization.html](http://blog.belvg.com/magento-certified-developer-exam-application-initialization.html).


# 0. Request Flow Image

TODO



# 1. index.php


1. Vérifie les prérequis PHP (>= version php 5.3)
2. Vérifie le Compiler et inclut la classe compiler
3. Vérifie la présence du downloader, si oui exit
4. Vérifie le maintenance.flag, si oui exit
5. Inclusion du fichier Mage.php
6. Vérifie les variables server `$_SERVER['MAGE_RUN_CODE']` et  `$_SERVER['MAGE_RUN_CODE']` 
7. Lance `Mage::run($mageRunCode, $mageRunType);`


### 1.1. Notes on MAGE_RUN_CODE and MAGE_RUN_TYPE

**MAGE_RUN_TYPE**

Par défaut c'est `store` si `$_SERVER['MAGE_RUN_CODE']` n'est pas défini

- store (store view)
- website (website)
- group (store)


**MAGE_RUN_CODE**

C'est le code, par exemple *base* ou *german* et la valeur associé à quel store/group/website on a besoin de charger.

**Examples:**

1. German website

    SetEnv MAGE_RUN_TYPE "website"
    SetEnv MAGE_RUN_CODE "german"


2. German Store View/Store

    SetEnv MAGE_RUN_CODE "german"


**Note:** Ils sont utilisés aussi par le processus d'initalization dans `Mage_Core_Model_App->\_initCurrentStore($scopeCode, $scopeType)`


# 2. Mage::run($code, $store); (*app/Mage.php*)

**Note:** Avant de commencer à regarder, il faut noter que le début du fichier autoloader et les chemins d'inclusions (includes paths) on été traités dans Before we begin looking at this, please note that at the top of the file the autoloader and include paths have been [set](https://github.com/pbouttier/magento-exam-notes/blob/master/1.%20Basics/1.%20Architecture/6.%20Explain%20class%20naming%20conventions%20and%20their%20relationship%20with%20the%20autoloader.md).

Overview

1. Vérifie les options (3ème paramètres)
2. Appelle app class `Mage_Core_Model_App`
3. Définie l'application comme installé
4. Définie le model de config `Mage_Core_Model_Config` avec le tableau d'options 
5. Appelle `Mage_Core_Model_App->run(array $options);`


### 2.1 Notes

Il faut noter que si il existe une option `config_model` alors ce Model de Config va être utlisé à la place.
I am not sure why you would want to do this.


# 3. Mage_Core_Model_App->run(array $options);

1. Charge local.xml et config.xml dans `baseInit()`
2. Vérifie si la requête est en cache et si oui on envoi la réponse
3. Sinon cela charge les modules dans `\_initModules();` et démarre également la ressource de mise à jour/installation des scripts
4. Charge l'aire (area) (frontend/admin/install)
5. Définie le magasin courant (store) depuis les paramètres
6. Lance le script de mise à jour des données Data `Mage_Core_Model_Resource_Setup::applyAllDataUpdates();` (différent du script de mise à jour des scripts)
7. Appelle le front controller

# 4. Mage_Core_Model_App->baseInit($options)

1. Sets the error handler
2. Initiates the config
3. Sets the options in the config class
4. Loads the config.xml and local.xml into Config Class -  Mage_Core_Model_Config->loadBase()
5. Initiates caching

# 5. Mage_Core_Model_Config->loadBase()

This merges the XML from under app/etc into the config class.
So basically config.xml and local.xml would be merged in the config class.

So it does the following:

- Loads the XML files under app/etc e.g. config.xml and local.xml using *glob*
- Loops through these files
- Clones Mage_Core_Model_Config_Base
- Adds xml from the file to this class
- Merges Mage_Core_Model_Config_Base into Mage_Core_Model_Config

# 6. Mage_Core_Model_App->\_initModules();

So in Mage_Core_Model_App->run() we check if the request is cached and return the cache if it exists.

Other we call this method and this does the following if the modules are not already cached:

- Load Modules
- Merges config data from Database
- Runs Resource Install/Update scripts
- Processes and configuration values in the config.xml
- Saves Cache

### 6.1 Loading modules

Mage_Core_Model_Config->loadModules();

- Loads modules under app/etc/modules using glob
- Loads modules it depends on
- Merges config.xml into config node of class Mage_Core_Model_Config
- **Important:** Merges back in local.xml file afterwards to prevent overrides

Then it runs setup updates by checking version numbers of the modules against the database table core_resource.

### 6.2 Merges Config data from database

Mage_Core_Model_App::loadDb()

### 6.3 Runs Resource Install/Update scripts


     Mage_Core_Model_Resource_Setup::applyAllUpdates();


Its important to note the name of the class and method for the exam and that this runs before the data scripts.
Data updates are called in the applyAllDataUpdates() method of the class.


# 7. Mage_Core_Model_App->\_initCurrentStore($scopeCode, $scopeType);

As mentioned earlier these parameters are set at the end of the index.php and are passed through to Mage::run();


# 8. Important Notes

**Merging Config.xml**

Magento loads config.xml and local.xml and adds them to the config class.
It loads the modules config.xml and merges them into the config class.
It then loads the local.xml file and re-merges it into the config class to prevent overrides by modules.\

**Scripts:**
Resource Scripts are called before Data Scripts and also when the config merges the database config.
