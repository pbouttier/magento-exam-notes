# Setting up a CRON


# 1. Registering a CRON

On peut enregistrer un CRON dans notre module via le fichier *config.xml* sous la node <global>

```xml
<global>
    <crontab>
        <jobs>
            <colin_bootstrap_cron>
                <schedule>
                   <cron_expr>*/1 * * * *</cron_expr>
                </schedule>
                <run>
                    <model>colin_bootstrap/observer_cron::runCustomCronJob</model>
                </run>
            </colin_bootstrap_cron>
        </jobs>
    </crontab>
</global>
```

**namespace_namemodule_cron** le nom du CRON stocké en base de donnée
**cron_expr** CRON expression
**namespace_namemodule/observer_cron::runCustomCronJob** La classe et la méthode utilisé par le CRON.

La classe ressemblera à:

**app/code/local/NameSpace/NameModule/Model/Observer/Cron.php**

```php
class NameSpace_NameModule_Model_Observer_Cron extends Mage_Core_Model_Abstract
{
    public function runCustomCronJob(Mage_Cron_Model_Schedule $observer)
    {
        Mage::log("Cron has ran.", null, 'cron.log', true);
        return $this;
    }

}
```


# 2. How Magento CRON's work

Un CRON marche comme suit:
* un CRON appel depuis le serveur *cron.php* depuis la racine du projet
* *cron.php* charge les évenèments observés et et dispatch les évenèments

Donc dans *cron.php* on aura ce code appellé:

```php
Mage::getConfig()->init()->loadEventObservers('crontab');
```
Cela boucle sur les observers pour chaque aire de crontab défini et dispatch leurs évenèments.

Donc *Mage_Cron_Model_Observer::dispatch()* est appellé dans cette boucle et fait le traitement suivant:

1. Process scheduled cron queue: Magento reads the cron schedule table for jobs that need to be executed this very second and jobs that should have already been executed, i.e. with timestamps in the past, that haven’t expired. The expiry limit is also a parameter, configurable in the admin panel. After all the work, dispatch method calls two generate() and cleanup() methods

2. Generate tasks schedule: Mage_Cron_Model_Observer->generate(), this method searches final configuration file for content of <crontab> nodes ($config = Mage::getConfig()->getNode(‘crontab/jobs’); ), reading <schedule><cron_expr> elements to find out when and how often they need to be executed and pulls this data into the cron_schedule table.

3. Cleanup: Mage_Cron_Model_Observer->cleanup(), this method deletes completed (with ‘success’ status) or missed ($time < $now – $scheduleLifetime, where $scheduleLifetime are set in Magento admin area) jobs from cron_schedule DB table.

**Note::** Information above extracted from [http://blog.belvg.com/magento-certified-developer-exam-setting-up-a-cron-job.html](http://blog.belvg.com/magento-certified-developer-exam-setting-up-a-cron-job.html)


# 3. Magento Admin configuration

Mage_Cron_Model_Observer know how and when to do the following tasks above based off the configuration settings for the CRON. These can be found under System -> Configuration -> System and in the Cron tab.

- **Generate Schedules Every** - Schedules the setup frequency of the CRON jobs in the database,
- **Schedule Ahead for** - How far to schedule ahead for.
- **Missed if Not Run Within** - How many minutes can a CRON be run after it was scheduled. Otherwise it will be set to "miss" when the CRON runs and the time has exceeded.
- **History Cleanup Every** - Magento will clean up history not more than setup amount of minutes.
- **Success History Lifetime** - How long completed tasks with "success" will be stored in the database.
- **Failure History Lifetime** - How long completed tasks with "missed" or "error" will be stored in the database.



## Further Reading
[http://blog.belvg.com/magento-certified-developer-exam-setting-up-a-cron-job.html](http://blog.belvg.com/magento-certified-developer-exam-setting-up-a-cron-job.html)
